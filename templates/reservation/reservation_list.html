{% extends 'base.html' %}
{% block title %}Reservations â€” LibraryMS{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <h4 class="fw-bold mb-0"><i class="bi bi-bookmark me-2"></i>Book Reservations</h4>
</div>

<!-- Filter -->
<div class="card mb-3">
  <div class="card-body py-2">
    <form method="get" class="d-flex gap-2 align-items-center flex-wrap">
      <label class="text-muted small mb-0">Filter by status:</label>
      <select name="status" class="form-select form-select-sm" style="width:160px;" onchange="this.form.submit()">
        <option value="">All</option>
        <option value="pending" {% if status_filter == 'pending' %}selected{% endif %}>Pending</option>
        <option value="ready" {% if status_filter == 'ready' %}selected{% endif %}>Ready for Pickup</option>
        <option value="fulfilled" {% if status_filter == 'fulfilled' %}selected{% endif %}>Fulfilled</option>
        <option value="cancelled" {% if status_filter == 'cancelled' %}selected{% endif %}>Cancelled</option>
        <option value="expired" {% if status_filter == 'expired' %}selected{% endif %}>Expired</option>
      </select>
    </form>
  </div>
</div>

<!-- Table -->
<div class="card">
  <div class="card-body p-0">
    <table class="table table-hover mb-0">
      <thead class="table-light">
        <tr>
          <th>Book</th>
          <th>Student</th>
          <th>Reserved On</th>
          <th>Expires On</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for r in reservations %}
        <tr>
          <td>
            <div class="fw-semibold">{{ r.book.title|truncatechars:30 }}</div>
            <small class="text-muted">{{ r.book.author }}</small>
          </td>
          <td>{{ r.user.get_full_name|default:r.user.username }}</td>
          <td>{{ r.reserved_on|date:"d M Y" }}</td>
          <td>{{ r.expires_on|date:"d M Y" }}</td>
          <td>
            {% if r.status == 'pending' %}
              <span class="badge" style="background:#fff3cd; color:#856404;">Pending</span>
            {% elif r.status == 'ready' %}
              <span class="badge" style="background:#d1e7dd; color:#0a3622;">Ready for Pickup</span>
            {% elif r.status == 'fulfilled' %}
              <span class="badge" style="background:#cfe2ff; color:#084298;">Fulfilled</span>
            {% elif r.status == 'cancelled' %}
              <span class="badge" style="background:#e2e3e5; color:#41464b;">Cancelled</span>
            {% elif r.status == 'expired' %}
              <span class="badge" style="background:#f8d7da; color:#842029;">Expired</span>
            {% endif %}
          </td>
          <td>
            <div class="d-flex gap-1">
              {% if user.is_admin_user or user.is_librarian_user %}
                {% if r.status == 'pending' %}
                  <a href="{% url 'reservation:mark_ready' r.pk %}"
                     class="btn btn-sm btn-outline-success" title="Mark Ready for Pickup">
                    <i class="bi bi-check-circle"></i>
                  </a>
                {% endif %}
                {% if r.status == 'ready' %}
                  <a href="{% url 'reservation:fulfill_reservation' r.pk %}"
                     class="btn btn-sm btn-outline-primary" title="Fulfill Reservation">
                    <i class="bi bi-box-arrow-in-right"></i>
                  </a>
                {% endif %}
              {% endif %}
              {% if r.status == 'pending' or r.status == 'ready' %}
                <a href="{% url 'reservation:cancel_reservation' r.pk %}"
                   class="btn btn-sm btn-outline-danger" title="Cancel"
                   onclick="return confirm('Cancel this reservation?')">
                  <i class="bi bi-x-circle"></i>
                </a>
              {% endif %}
            </div>
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="6" class="text-center text-muted py-5">
            <i class="bi bi-bookmark" style="font-size:2rem;"></i>
            <p class="mt-2">No reservations found.</p>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endblock %}