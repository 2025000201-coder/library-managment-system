{% extends 'base.html' %}
{% block title %}{{ existing|yesno:"Edit,Write" }} Review â€” LibraryMS{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <h4 class="fw-bold mb-0">
    <i class="bi bi-star me-2 text-warning"></i>
    {{ existing|yesno:"Edit Your Review,Write a Review" }}
  </h4>
  <a href="{% url 'books:book_detail' book.pk %}" class="btn btn-outline-secondary btn-sm">
    <i class="bi bi-arrow-left me-1"></i>Back to Book
  </a>
</div>

<div class="row justify-content-center">
  <div class="col-md-7">

    <!-- Book Info -->
    <div class="card mb-4">
      <div class="card-body d-flex gap-3 align-items-center">
        {% if book.cover_image %}
          <img src="{{ book.cover_image.url }}" class="rounded" style="width:55px;height:75px;object-fit:cover;">
        {% else %}
          <div class="rounded d-flex align-items-center justify-content-center flex-shrink-0"
               style="width:55px;height:75px;background:linear-gradient(135deg,#4361ee,#3a86ff);">
            <i class="bi bi-book text-white fs-4"></i>
          </div>
        {% endif %}
        <div>
          <div class="fw-bold">{{ book.title }}</div>
          <div class="text-muted small">{{ book.author }}</div>
        </div>
      </div>
    </div>

    <!-- Review Form -->
    <div class="card">
      <div class="card-body p-4">
        <form method="POST">
          {% csrf_token %}

          <!-- Star Rating -->
          <div class="mb-4">
            <label class="form-label fw-semibold">Your Rating</label>
            <div class="d-flex gap-2 mb-2" id="starContainer">
              {% for i in "12345" %}
              <i class="bi bi-star-fill fs-2 star-btn" data-val="{{ i }}"
                 style="color:#dee2e6; cursor:pointer; transition:color 0.15s;"></i>
              {% endfor %}
            </div>
            <input type="hidden" name="rating" id="ratingInput" value="{{ form.rating.value|default:'' }}">
            <div class="text-danger small" id="ratingError" style="display:none;">Please select a rating.</div>
          </div>

          <!-- Comment -->
          <div class="mb-4">
            <label class="form-label fw-semibold">Your Review <span class="text-muted fw-normal">(optional)</span></label>
            {{ form.comment }}
          </div>

          <div class="d-flex gap-2">
            <button type="submit" class="btn btn-warning fw-semibold">
              <i class="bi bi-star me-1"></i>
              {{ existing|yesno:"Update Review,Submit Review" }}
            </button>
            <a href="{% url 'books:book_detail' book.pk %}" class="btn btn-outline-secondary">Cancel</a>
          </div>
        </form>
      </div>
    </div>

  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  const stars = document.querySelectorAll('.star-btn');
  const ratingInput = document.getElementById('ratingInput');

  let current = parseInt(ratingInput.value) || 0;
  highlightStars(current);

  stars.forEach(star => {
    star.addEventListener('click', () => {
      current = parseInt(star.dataset.val);
      ratingInput.value = current;
      highlightStars(current);
    });
    star.addEventListener('mouseover', () => highlightStars(parseInt(star.dataset.val)));
    star.addEventListener('mouseout', () => highlightStars(current));
  });

  function highlightStars(n) {
    stars.forEach((s, i) => {
      s.style.color = i < n ? '#ffc107' : '#dee2e6';
    });
  }

  document.querySelector('form').addEventListener('submit', e => {
    if (!ratingInput.value) {
      e.preventDefault();
      document.getElementById('ratingError').style.display = 'block';
    }
  });
</script>
{% endblock %}